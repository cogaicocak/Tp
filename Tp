-- TeleportIslands GUI Script (FIXED - Bay m∆∞·ª£t kh√¥ng gi·∫≠t)
-- ƒê·∫∑t script n√†y v√†o StarterGui ho·∫∑c StarterPlayerScripts

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- Danh s√°ch c√°c ƒë·∫£o
local islands = {
    {name = "Peanut Island", position = Vector3.new(-2158.17, 38.36, -10193.24)},
    {name = "Icecream Island", position = Vector3.new(-863.93, 66.08, -11019.04)},
    {name = "Tiki", position = Vector3.new(-16228.08, 9.32, 412.53)},
    {name = "Haunted Castle", position = Vector3.new(-9506.11, 142.36, 5526.04)},
    {name = "CakeLoaf", position = Vector3.new(-2145.42, 38.06, -11895.08)},
    {name = "Castle On The Sea", position = Vector3.new(-4999.45, 314.78, -3010.54)}
}

-- T·∫°o GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "IslandTeleportGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- Frame ch√≠nh
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 300, 0, 400)
mainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

-- Bo g√≥c cho frame
local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 10)
mainCorner.Parent = mainFrame

-- Title
local titleLabel = Instance.new("TextLabel")
titleLabel.Name = "Title"
titleLabel.Size = UDim2.new(1, 0, 0, 50)
titleLabel.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
titleLabel.BorderSizePixel = 0
titleLabel.Text = "üèùÔ∏è Island Teleporter"
titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
titleLabel.TextSize = 20
titleLabel.Font = Enum.Font.GothamBold
titleLabel.Parent = mainFrame

local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 10)
titleCorner.Parent = titleLabel

-- Close Button
local closeButton = Instance.new("TextButton")
closeButton.Name = "CloseButton"
closeButton.Size = UDim2.new(0, 40, 0, 40)
closeButton.Position = UDim2.new(1, -45, 0, 5)
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.BorderSizePixel = 0
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.TextSize = 18
closeButton.Font = Enum.Font.GothamBold
closeButton.Parent = mainFrame

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 8)
closeCorner.Parent = closeButton

-- ScrollingFrame cho danh s√°ch ƒë·∫£o
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Name = "IslandList"
scrollFrame.Size = UDim2.new(1, -20, 1, -70)
scrollFrame.Position = UDim2.new(0, 10, 0, 60)
scrollFrame.BackgroundTransparency = 1
scrollFrame.BorderSizePixel = 0
scrollFrame.ScrollBarThickness = 6
scrollFrame.Parent = mainFrame

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 8)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Parent = scrollFrame

-- Bi·∫øn ƒë·ªÉ ki·ªÉm so√°t tween
local currentTween = nil
local isTweening = false
local bodyVelocity = nil
local bodyGyro = nil

-- H√†m tween m∆∞·ª£t m√† ƒë·∫øn ƒë·∫£o (FIXED - Bay th·∫≥ng kh√¥ng gi·∫≠t)
local function teleportToIsland(targetPosition)
    if isTweening then
        warn("ƒêang di chuy·ªÉn, vui l√≤ng ƒë·ª£i!")
        return
    end
    
    -- C·∫≠p nh·∫≠t character v√† HumanoidRootPart
    character = player.Character
    if not character then return end
    humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    isTweening = true
    
    -- T·∫ÆT COLLISION V√Ä GRAVITY ƒê·ªÇ BAY M∆Ø·ª¢T
    -- L∆∞u tr·∫°ng th√°i c≈©
    local oldCanCollide = {}
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            oldCanCollide[part] = part.CanCollide
            part.CanCollide = false
        end
    end
    
    -- T·∫°o BodyVelocity ƒë·ªÉ ch·ªëng gravity v√† gi·ªØ v·∫≠n t·ªëc ·ªïn ƒë·ªãnh
    bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(100000, 100000, 100000)
    bodyVelocity.Parent = humanoidRootPart
    
    -- T·∫°o BodyGyro ƒë·ªÉ gi·ªØ h∆∞·ªõng ·ªïn ƒë·ªãnh
    bodyGyro = Instance.new("BodyGyro")
    bodyGyro.MaxTorque = Vector3.new(100000, 100000, 100000)
    bodyGyro.CFrame = humanoidRootPart.CFrame
    bodyGyro.P = 10000
    bodyGyro.D = 500
    bodyGyro.Parent = humanoidRootPart
    
    -- ƒê·∫∑t Humanoid state ƒë·ªÉ tr√°nh animation can thi·ªáp
    humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
    humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
    humanoid:ChangeState(Enum.HumanoidStateType.Physics)
    
    -- T√≠nh kho·∫£ng c√°ch v√† th·ªùi gian
    local startPos = humanoidRootPart.Position
    local distance = (targetPosition - startPos).Magnitude
    local tweenSpeed = 350
    local tweenTime = distance / tweenSpeed
    
    -- T√≠nh h∆∞·ªõng bay (LookVector)
    local direction = (targetPosition - startPos).Unit
    local targetCFrame = CFrame.new(startPos, startPos + direction)
    
    -- T·∫†O TWEEN CHO POSITION (Bay th·∫≥ng)
    local tweenInfo = TweenInfo.new(
        tweenTime,
        Enum.EasingStyle.Linear,
        Enum.EasingDirection.InOut,
        0,
        false,
        0
    )
    
    -- H·ªßy tween c≈© n·∫øu c√≥
    if currentTween then
        currentTween:Cancel()
    end
    
    -- TWEEN POSITION TR·ª∞C TI·∫æP thay v√¨ CFrame ƒë·ªÉ tr√°nh rotation
    local goal = {CFrame = CFrame.new(targetPosition) * CFrame.Angles(0, humanoidRootPart.CFrame.Rotation.Y, 0)}
    currentTween = TweenService:Create(humanoidRootPart, tweenInfo, goal)
    
    -- C·∫≠p nh·∫≠t BodyGyro trong su·ªët qu√° tr√¨nh bay ƒë·ªÉ gi·ªØ h∆∞·ªõng
    local connection
    connection = RunService.RenderStepped:Connect(function()
        if bodyGyro and bodyGyro.Parent then
            -- Gi·ªØ h∆∞·ªõng nh√¨n v·ªÅ ph√≠a ƒë√≠ch
            local currentDirection = (targetPosition - humanoidRootPart.Position).Unit
            bodyGyro.CFrame = CFrame.new(humanoidRootPart.Position, humanoidRootPart.Position + currentDirection)
        end
    end)
    
    -- X·ª≠ l√Ω khi tween ho√†n th√†nh
    currentTween.Completed:Connect(function(playbackState)
        isTweening = false
        
        -- Ng·∫Øt k·∫øt n·ªëi RenderStepped
        if connection then
            connection:Disconnect()
        end
        
        -- X√≥a BodyVelocity v√† BodyGyro
        if bodyVelocity then
            bodyVelocity:Destroy()
            bodyVelocity = nil
        end
        if bodyGyro then
            bodyGyro:Destroy()
            bodyGyro = nil
        end
        
        -- Kh√¥i ph·ª•c collision
        for part, canCollide in pairs(oldCanCollide) do
            if part and part.Parent then
                part.CanCollide = canCollide
            end
        end
        
        -- Kh√¥i ph·ª•c Humanoid state
        humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, true)
        humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, true)
        humanoid:ChangeState(Enum.HumanoidStateType.Freefall)
        
        currentTween = nil
        print("‚úÖ ƒê√£ ƒë·∫øn ƒë·∫£o!")
    end)
    
    currentTween:Play()
    print("‚úàÔ∏è ƒêang bay ƒë·∫øn ƒë·∫£o...")
end

-- T·∫°o button cho m·ªói ƒë·∫£o
for i, island in ipairs(islands) do
    local islandButton = Instance.new("TextButton")
    islandButton.Name = island.name
    islandButton.Size = UDim2.new(1, -10, 0, 45)
    islandButton.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
    islandButton.BorderSizePixel = 0
    islandButton.Text = island.name
    islandButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    islandButton.TextSize = 16
    islandButton.Font = Enum.Font.Gotham
    islandButton.Parent = scrollFrame
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = islandButton
    
    -- Hi·ªáu ·ª©ng hover
    islandButton.MouseEnter:Connect(function()
        if not isTweening then
            islandButton.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
        end
    end)
    
    islandButton.MouseLeave:Connect(function()
        islandButton.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
    end)
    
    -- X·ª≠ l√Ω click
    islandButton.MouseButton1Click:Connect(function()
        if not isTweening then
            islandButton.BackgroundColor3 = Color3.fromRGB(80, 150, 80)
            teleportToIsland(island.position)
            wait(0.2)
            islandButton.BackgroundColor3 = Color3.fromRGB(50, 50, 65)
        end
    end)
end

-- C·∫≠p nh·∫≠t canvas size
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
end)

-- X·ª≠ l√Ω n√∫t ƒë√≥ng
closeButton.MouseButton1Click:Connect(function()
    mainFrame.Visible = not mainFrame.Visible
end)

-- L√†m frame c√≥ th·ªÉ k√©o
local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

titleLabel.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

titleLabel.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- X·ª≠ l√Ω khi character respawn
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    isTweening = false
    
    -- D·ªçn d·∫πp n·∫øu ƒëang tween
    if currentTween then
        currentTween:Cancel()
        currentTween = nil
    end
    if bodyVelocity then
        bodyVelocity:Destroy()
        bodyVelocity = nil
    end
    if bodyGyro then
        bodyGyro:Destroy()
        bodyGyro = nil
    end
end)

print("‚úÖ Island Teleporter GUI ƒë√£ load th√†nh c√¥ng! (FIXED - Bay m∆∞·ª£t)")
